# 변수 프롬프트: AI가 변수를 이해하게 만들기

지난 장에서 우리는 성공적으로 변수를 설정하고 초기화했습니다. 하지만 이것은 어디까지나 **실리태번 차원**에서 캐릭터 카드에 변수를 할당한 것일 뿐, 아직 AI에게 "이런 변수가 있다"고 알려주지는 않은 상태입니다. 비유하자면 이렇습니다. 캐릭터 카드에는 보통 프로필 이미지가 있죠? 하지만 우리가 AI에게 따로 말해주지 않으면, AI는 당신이 이 캐릭터에 어떤 사진을 걸어뒀는지 전혀 모르는 것과 같습니다.

그렇다면, 어떻게 해야 AI가 이 변수들을 "보고" 우리의 의도대로 조작하게 만들 수 있을까요? 바로 월드 인포(World Info)에 **프롬프트**를 작성해서, AI에게 변수에 대한 **3가지 핵심 정보**를 알려줘야 합니다.

## 변수의 3가지 핵심 정보

**변수 목록 (Variable List)**
* 현재 변수의 값은 얼마인가? 그리고 그 값은 어떤 의미인가?
* *예시:* `하쿠아.의존도`라는 변수의 현재 수치는? 0일 때와 100일 때 각각 무슨 뜻인가?

**변수 업데이트 규칙 (Variable Update Rules)**
* 변수는 어떤 상황에서 업데이트되어야 하며, 어떤 값으로 변해야 하는가?
* *예시:* `하쿠아.의존도`는 어떤 스토리 전개에서 상승해야 하고, 반대로 어떤 상황에서 하락해야 하는가?

**변수 출력 형식 (Variable Output Format)**
* AI는 변수를 업데이트하기 위해 **무엇을 출력**해야 하는가?
* *예시:* AI가 "하쿠아가 주인공과 데이트를 했으니 `하쿠아.의존도`를 20에서 25로 올려야겠다"고 판단했다면, MVU 스크립트가 이를 알아듣고 실제로 25로 고칠 수 있도록 **어떤 텍스트를 내뱉어야 하는가?**



!!! question "혹시 이해가 잘 안 되시나요? ㅠㅠ"
    저... 다른 비유를 하나 더 들어볼게요! 만약 우리가 **"스토리 진행에 따라 AI가 알아서 캐릭터 프사를 바꾸게"** 만들고 싶다면 어떻게 해야 할까요?

    * **변수 목록:** 현재 캐릭터의 프사는 무엇인가? (웃는 얼굴? 우는 얼굴?) 그게 무슨 의미인가?
    * **변수 업데이트 규칙:** 캐릭터 프사는 어떤 상황에서 바뀌어야 하는가? (슬픈 일엔 우는 얼굴로?)
    * **변수 출력 형식:** AI가 프사를 바꾸려면 무엇을 출력해야 하는가? (아마도 직접 이미지 파일을 출력하거나, 파일명을 말해야겠죠! 그러면 '프사 교체 스크립트'가 그걸 보고 사진을 바꿔줄 겁니다.)



## 세 가지 변수 프롬프트 간단하게 제작하기

여러분이 머리를 싸맬 필요 없이, 거의 **거저먹기 수준**으로 변수 목록, 업데이트 규칙, 출력 형식을 얻을 수 있는 방법이 있습니다.

### 1. `[mvu_update]` 변수 업데이트 규칙
이전에 '변수 구조 설계'를 생성할 때 썼던 채팅을 이어서 진행합니다. **[문지기 카드 작성 도우미 - 변수 업데이트 규칙(Variable Update Rules)]** 항목으로 전환한 뒤, 특별히 강조하고 싶은 규칙을 입력하고 AI에게 생성을 요청하세요. 그 후 생성된 결과를 입맛에 맞게 조금만 다듬으면 됩니다.
> *예시 입력:* "`하쿠아`의 `칭호`는 반드시 주인공에 대한 하쿠아의 태도를 반영해서 변해야 해."

### 2. `[mvu_update]` 변수 출력 형식 및 변수 목록
이건 더 쉽습니다. 그냥 도우미가 생성해 준 **`[mvu_update] 변수 출력 형식`**과 **`변수 목록`** 내용을 그대로 복사하세요.

이렇게 하면 우리는 **3대 변수 프롬프트**를 모두 손에 넣게 됩니다. 이제 아래 그림처럼 설정을 마치면, AI는 비로소 변수를 이해하고 스스로 업데이트할 수 있게 됩니다.

다음으로, **실리태번 우측 상단 블록 아이콘(Extensions)** ‣ **정규식(Regex)**으로 이동하여, 아래 버전 중 하나를 골라 3개의 정규식 스크립트를 **로컬 정규식(Local Regex)**으로 가져옵니다.

* **예쁘게 꾸민 버전** ([예시 보기](https://gitgud.io/StageDog/tavern_resource/-/raw/main/src/%E6%AD%A3%E5%88%99/%E5%8F%98%E9%87%8F%E6%9B%B4%E6%96%B0/%E7%BE%8E%E5%8C%96%E7%89%88.mp4)): <a href="../../assets/files/regex-remove-variable-update.json" download="regex-[不发送]去除变量更新.json">`[전송안함]변수 업데이트 제거`</a>, <a href="../../assets/files/regex-beautify-variable-updating.json" download="regex-[美化]变量更新中.json">`[미화]변수 업데이트 중`</a>, <a href="../../assets/files/regex-beautify-variable-complete.json" download="regex-[美化]完整变量更新.json">`[미화]변수 업데이트 완료`</a>
* **접기 버전** ([예시 보기](https://gitgud.io/StageDog/tavern_resource/-/raw/main/src/%E6%AD%A3%E5%88%99/%E5%8F%98%E9%87%8F%E6%9B%B4%E6%96%B0/%E6%8A%98%E5%8F%A0%E7%89%88.mp4)): <a href="../../assets/files/regex-remove-variable-update.json" download="regex-[不发送]去除变量更新.json">`[전송안함]변수 업데이트 제거`</a>, <a href="../../assets/files/regex-fold-variable-updating.json" download="regex-[折叠]变量更新中.json">`[접기]변수 업데이트 중`</a>, <a href="../../assets/files/regex-fold-variable-complete.json" download="regex-[折叠]完整变量更新.json">`[접기]변수 업데이트 완료`</a>
* **알림 전용 버전** (내용 펼치기 불가): <a href="../../assets/files/regex-remove-variable-update.json" download="regex-[不发送]去除变量更新.json">`[전송안함]변수 업데이트 제거`</a>, `[알림]변수 업데이트 중`, `[알림]변수 업데이트 완료`

(알림 전용 버전은 문서 내에서 원본 파일이 삭제되어서 없음 양해 바람)

이렇게 하면 변수 프롬프트 작성이 끝났으니, 바로 다음 장으로 넘어가셔도 됩니다! 하지만 각 프롬프트가 도대체 **무슨 역할을 하고, 어떤 원리로 작동하는지** 한번 짚고 넘어가는 것을 강력 추천합니다.

## 변수 목록

변수 목록은 AI에게 **변수의 현재 값이 얼마인지**, 그리고 **변수가 어떤 의미인지**를 알려주는 역할을 합니다.

하지만 '문지기 카드 작성 도우미'에 작성된 변수 목록 프롬프트를 보면 코드가 매우 간단합니다.

```xml
---
<status_current_variable>
{{format_message_variable::stat_data}}
</status_current_variable>
```

도대체 이 간단한 코드로 어떻게 AI가 변수의 값과 의미를 알 수 있다는 걸까요?

그 이유는 바로 메시지가 실제로 전송될 때, {{format_message_variable::stat_data}} 부분이 그대로 날아가는 것이 아니라 실제 변수 내용으로 교체(치환)되어 전송되기 때문입니다.

=== "프롬프트"

    ```xml
    ---
    <status_current_variable>
    {{format_message_variable::stat_data}}
    </status_current_variable>
    ```

=== "AI에게 전송된 결과"

    ```yaml
    ---
    <status_current_variable>
    세계:
      현재 시간: 2024년 4월 8일 10:45
      현재 장소: 사립 카자마츠리 학원 고등부 2학년 A반 교실
      최근 사건:
        전학생 배치: 하쿠아가 막 전학 옴. 교재를 수령하고 학교 환경을 익혀야 함
        자리 조정: 반장이 최종 좌석표를 확인 중이며, 미세한 조정이 있을 수 있음
        점심시간 임박: 점심시간까지 수업이 딱 하나 남음. 하쿠아와 접촉할 기회임
    백아:
      의존도: 35
      복장:
        상의: 깔끔한 짙은 남색 교복 재킷, 단추를 하나하나 꼼꼼하게 채움
        하의: 단정한 짙은 남색 주름치마, 무릎까지 오는 길이
        속옷: 무늬 없는 흰색 속옷 세트
        양말: 검은색 오버니삭스, 주름 하나 없이 팽팽함
        신발: 검은색 가죽 학생화, 반짝이게 닦여 있음
        장신구: 없음
      칭호:
        행시(Living Dead):
          효과: 일상 행동에서 명백한 권태감과 기계적인 느낌이 묻어남
          자평: 살아있는 것 자체가 형벌이야
        도피자:
          효과: 청공려의 모든 접근을 본능적으로 회피함
          자평: 난 그 사람 인생에 나타날 자격이 없어
    주인공:
      소지품:
        낡은 반창고:
          설명: 지갑 안쪽에 2년 동안 넣어둔 캐릭터 반창고. 접착력은 아마 다 사라졌을 것임
          수량: 1
        박하사탕:
          설명: 잠 깰 때 먹는 강력 박하사탕. 예전에 그녀는 이 냄새를 아주 싫어했음
          수량: 1
    </status_current_variable>
    ```

=== "프롬프트 검사기"

    ![프롬프트 검사기](https://vwdygpvfycixugqsgwgn.supabase.co/storage/v1/object/public/post-images/1980dc04-3f08-4581-88cb-b949a10d585b/8bf79453-8ebd-4b21-85e2-ecd530b05a1a.png)


프롬프트와 실제로 전송되는 내용이 서로 다른 경우는 이번이 처음이 아닙니다.

캐릭터 카드를 하나 열어서 **오프닝 메시지(Greeting)**를 확인해 보세요. 분명 작성할 때는 `<user>`라고 적었지만, 화면에 표시되거나 AI에게 전송될 때는 구체적인 사용자 이름으로 바뀌어 있는 것을 볼 수 있습니다.    

<p align="center">
  <img src="https://vwdygpvfycixugqsgwgn.supabase.co/storage/v1/object/public/post-images/1980dc04-3f08-4581-88cb-b949a10d585b/40b06506-a303-483a-861f-70694538613d.png" width="600">
</p>

즉, `{{format_message_variable::stat_data}}`, `<user>` 같은 텍스트는 단지 **자리 표시자** 역할을 할 뿐이며, 실제로 화면에 표시되거나 전송될 때는 **구체적인 내용으로 교체**됩니다.

이러한 자리 표시 텍스트를 **"매크로"**라고 부릅니다.

* `<user>` 또는 `{{user}}`는 **실리태번 기본 매크로**입니다. 실리태번 입력창에 `/help macros`를 입력하고 엔터를 치면 실리태번이 어떤 매크로들을 제공하는지 알 수 있습니다.
* 반면, `{{format_message_variable::변수}}`는 **실리태번 도우미(MVU)가 새로 등록한 매크로**입니다.

### 실리태번 도우미 매크로 `{{format_message_variable::변수}}`

실리태번의 기능을 확장하고 변수를 더 잘 지원하기 위해, 실리태번 도우미는 사용자가 직접 **도우미 매크로를 등록**할 수 있도록 허용하며, 미리 `{{format_message_variable::변수}}` 매크로를 제공하고 있습니다. 이 매크로의 역할은 **최신 메시지 층(Layer/Floor)의 변수 값을 보여주는 것**입니다.

여기서 `변수`는 표시하려는 **변수의 경로(Path)**를 뜻합니다. 즉, `{{format_message_variable::stat_data}}`는 `stat_data` 경로 아래에 있는 변수 내용을 보여준다는 뜻입니다.

...어지러우신가요? 괜찮습니다! 다시 한번 <span class="highlight-box">**실리태번 입력창 왼쪽 마술봉 아이콘 ‣ 변수 관리자 ‣ 메시지**</span> 탭을 열어서 눈으로 확인해 봅시다.

<p align="center">
 <img src="https://vwdygpvfycixugqsgwgn.supabase.co/storage/v1/object/public/post-images/1980dc04-3f08-4581-88cb-b949a10d585b/4290386d-e62d-4230-b420-6dc502b59446.png" width="600">
 </p>

 `stat_data` 변수 아래에는 놀랍게도 우리가 설정한 **모든 변수**가 들어있습니다!

따라서 `{{format_message_variable::stat_data}}`를 사용하면, 우리가 설정한 모든 변수들이 정해진 서식에 맞춰 한 번에 표시되는 것입니다! **변수 목록** 프롬프트는 바로 이 점을 이용하고 있습니다.

```xml
---
<status_current_variable>
{{format_message_variable::stat_data}}
</status_current_variable>
```

하지만 {{format_message_variable::변수}} 매크로는 stat_data뿐만 아니라 다른 경로도 사용할 수 있습니다.

한번 변수 관리자에서 다른 경로를 복사해서 테스트해 봅시다. **"현재 시간(Current Time)"**을 클릭한 다음, 변수 관리자 상단의 탐색 바를 눌러 편집 상태로 만들고, 그 경로를 복사해 보세요.

<p align="center">
  <img src="https://vwdygpvfycixugqsgwgn.supabase.co/storage/v1/object/public/post-images/1980dc04-3f08-4581-88cb-b949a10d585b/40b06506-a303-483a-861f-70694538613d.png" width="600">
</p>

우리가 얻은 경로는 `stat_data.세계.현재 시간`입니다. 그러므로 실리태번 입력창에 `{{format_message_variable::stat_data.세계.현재 시간}}`을 입력하고 한번 전송해 봅시다.

<p align="center">
<img src="https://vwdygpvfycixugqsgwgn.supabase.co/storage/v1/object/public/post-images/1980dc04-3f08-4581-88cb-b949a10d585b/4d46cff7-1aa1-4329-af04-fdb94c6fc0a0.png" width="600">
</p>

예상대로 AI의 답변에 `2024-04-08 10:45`라는 시간이 정확히 나타났습니다!

!!! tip "팁"
    더 다양한 실리태번 도우미 매크로의 사용법은 [<u>실리태번 도우미 매크로 문서</u>](https://n0vi028.github.io/JS-Slash-Runner-Doc/guide/%E5%8A%9F%E8%83%BD%E8%AF%A6%E6%83%85/%E9%85%92%E9%A6%86%E5%8A%A9%E6%89%8B%E5%AE%8F.html)를 참고하세요.

## AI에게 변수 목록의 값이 '최신'임을 인식시키기

변수 목록은 변수의 현재 값을 나열하고 있습니다. 하지만 AI는 여전히 변수 목록의 값들이 **최신 스토리**에 해당하는 것이 아니라, 이전의 어떤 시점에 해당한다고 착각할 수 있습니다. 이것은 우리가 설정한 **월드 인포(World Info) 항목의 삽입 위치** 때문에 발생하는 문제입니다.

일반적으로, 기본 설정에서는 프롬프트가 다음과 같은 순서로 AI에게 전송됩니다.

```xml
* 캐릭터 정의 이전
* 캐릭터 정의 이후
* 0번째 메시지
* 1번째 메시지
* ...
* 뒤에서 3번째 메시지
* @D2
* 뒤에서 2번째 메시지 (마지막 AI 응답)
* @D1
* 뒤에서 1번째 메시지 (마지막 사용자 입력)
* @D0
```

여기서 `메시지(층)`는 플레이어의 입력과 AI의 응답을 의미합니다.

따라서 AI가 **"변수 목록의 내용이 최신 스토리(즉, 가장 최근의 AI 응답)와 대응된다"**는 것을 바로 이해하게 하려면, 변수 목록을 **@D1** 또는 **@D0** 위치에 배치해야 합니다.

<p align="center">
 <img src="https://vwdygpvfycixugqsgwgn.supabase.co/storage/v1/object/public/post-images/1980dc04-3f08-4581-88cb-b949a10d585b/93f79570-1e89-454d-b3e2-944d60f30248.png" width="600">
</p>

## 변수의 의미 구체적으로 설명하기

변수 목록은 AI에게 변수의 **현재 값**이 얼마인지 알려주는 것 외에도, 그 변수가 **어떤 의미인지** 설명하는 역할도 합니다.

`세계.현재 시간`, `세계.현재 장소`, `주인공.소지품` 등과 같이 이름만 봐도 그 의미를 알 수 있는 변수들도 있지만, 특수한 의미를 가지고 있어 **추가적인 설명이 필요한 변수**들도 있습니다.

예를 들어 `하쿠아.의존도`의 경우, AI는 이름만 보고도 이것이 '백아가 주인공에게 의지하는 정도'라는 것은 알 수 있습니다. 하지만 **구체적인 수치(예: 23)**일 때 백아가 어떤 심리 상태여야 하는지, 어떤 행동을 취해야 하는지는 알 수 없습니다.

이것이 바로 많은 카드 제작자들이 말하는 **"구간별 호감도"** 메커니즘입니다. 즉, 의존도 수치에 따라 백아는 서로 다른 행동과 심리 상태를 보여여 합니다.

우선은 **[캐릭터 단계]** 항목을 새로 만들고, 그 안에 의존도별 백아의 행동 양식을 간단히 나열해 볼 수 있습니다.

```text
하쿠아의 현재 행동: # 하쿠아의 현재 의존도는 {{format_message_variable::stat_data.백아.의존도}} 입니다. 따라서 하쿠아는 아래 예시와 유사한 행동을 취하려는 경향이 있습니다.
  # 0~19 일 때
  소극적 자기 파괴:
    ...
  # 20~39 일 때
  관심 갈구:
    ...
  # 40~59 일 때
  몰래 접근:
    ...
  # 60~79 일 때
  불안한 동행:
  # 80~100 일 때
  온순한 의존:
    ...
```

하지만 이 방법에는 분명한 문제가 있습니다. 현재 하쿠아의 의존도는 23인데, 우리는 0~19, 40~59 등 해당하지 않는 단계의 프롬프트까지 모두 전송하고 있습니다. 이는 입력 토큰을 낭비할 뿐만 아니라, AI의 주의력을 분산시켜 백아가 정확히 어떤 단계의 행동을 해야 할지 혼란스럽게 만들 수 있습니다.

다음 장에서 프롬프트 템플릿을 사용하여 이 문제를 깔끔하게 해결하는 방법을 알려드리겠습니다. 지금은 다시 돌아와서, 3대 변수 프롬프트 중 두 번째인 변수 업데이트 규칙에 대해 먼저 알아보겠습니다.

## 변수 업데이트 규칙 (Variable Update Rules)
변수 업데이트 규칙은 AI에게 어떤 상황에서 변수가 업데이트되어야 하는지, 그리고 어떤 값으로 업데이트되어야 하는지를 알려줍니다.

'문의 주인(Gatekeeper) 캐릭터 카드 작성 도우미'의 변수 업데이트 규칙 작성법은 변수 구조, 변수 초깃값, 변수 목록과 유사합니다.

???+ info "생성된 변수 업데이트 규칙"

    ```yaml
    변수 업데이트 규칙:
      세계:
        현재 시간:
          format: YYYY년MM월DD일 요일X HH:MM
        최근 사건:
          type: |-
            {
              [사건명: string]: string; // 사건 설명
            }
          check:
            - 완수해야 할 임무, 약속, 중요 사건 등을 기록
            - 완료 후 목록에서 제거, 새로운 사건 발생 시 즉시 추가
            - 활성 사건은 최대 5~8개로 유지하여 지나친 복잡화 방지
      바이야:
        의존도:
          type: number
          range: 0~100
          check:
            - <user>의 행동에 대한 바이야의 인지와 반응에 따라 조정 ±(3~6)
            - 바이야가 현재 <user>의 행동을 알아차렸을 때만 업데이트
        복장.${상의|하의|속옷|양말|신발|장신구}:
          check:
            - 환복, 의복 손상, 특수 상황 시 업데이트
            - 색상, 재질, 스타일 등의 디테일 포함하여 묘사
            - 바이야의 심리 상태와 <user>에 대한 관심 정도를 반영
        칭호:
          type: |-
            {
              [칭호명: string]: {
                효과: string;
                자기평가?: string;  // 기본값은 '평가 대기'
              }
            }
          check:
            - 바이야의 중요 행동, 심리 변화 또는 <user>와의 상호작용에 기반하여 획득
            - 자기평가가 '평가 대기'라면, 즉시 새로운 자기평가로 업데이트
            - 칭호는 바이야의 현재 의존 상태와 심리적 발전을 반영해야 함
            - 최대 Math.ceil(의존도/10)개의 칭호 유지, 초과 시 가장 먼저 획득한 것부터 제거
      주인공:
        아이템 슬롯:
          type: |-
            {
              [아이템명: string]: {
                설명: string;
                수량?: number;  // 기본값은 1
              }
            }
          check:
            - 아이템 획득, 소모, 버리기 시 수량 업데이트
            - 수량이 0이 되면 해당 항목 표시 안 함
    ```


예를 들어 하쿠아.의존도와 하쿠아.칭호는 다음과 같이 나열됩니다.

=== "변수 목록"

    ```yaml
    하쿠아:
      의존도: 15
      칭호:
        전학생:
          효과: 갓 전학 와서 환경이 낯섦. 타인의 주의를 끌기 쉽지만 본인은 눈에 띄지 않으려 함
          자기평가: 또 새로운 시작이지만, 난 분명 다시 모든 걸 망칠 거야
    ```

=== "변수 업데이트 규칙"

    ```yaml
    변수 업데이트 규칙:
      하쿠아:
        의존도:
          type: number
          range: 0~100
          check:
            - <user>의 행동에 대한 하쿠아의 인지와 반응에 따라 조정 ±(3~6)
            - 하쿠아가 현재 <user>의 행동을 알아차렸을 때만 업데이트
        칭호:
          type: |-
            {
              [칭호명: string]: {
                효과: string;
                자기평가?: string;  // 기본값은 '평가 대기'
              }
            }
          check:
            - 하쿠아의 중요 행동, 심리 변화 또는 <user>와의 상호작용에 기반하여 획득
            - 자기평가가 '평가 대기'라면, 즉시 새로운 자기평가로 업데이트
            - 칭호는 하쿠아의 현재 의존 상태와 심리적 발전을 반영해야 함
            - 최대 Math.ceil(의존도/10)개의 칭호 유지, 초과 시 가장 먼저 획득한 것부터 제거
    ```
