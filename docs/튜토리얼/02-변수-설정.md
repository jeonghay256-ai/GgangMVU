# 변수 설정 및 초기화
💡 튜토리얼에 사용된 예제 카드는 [<u>**캐릭터 카드 예시**</u>](https://github.com/StageDog/tavern_helper_template/tree/main/src/%E8%A7%92%E8%89%B2%E5%8D%A1%E7%A4%BA%E4%BE%8B)에서 찾을 수 있어요!

## 🤔 어떤 변수가 필요한지 고민하기
MVU 카드를 작성할 때는 먼저 이 카드에 어떤 변수가 필요한지 생각해야 합니다.

* **연애 시뮬레이션**: 캐릭터가 플레이어에게 느끼는 호감도를 기록해야겠죠? 호감도 단계에 따라 캐릭터의 행동 패턴을 다르게 설정할 수 있으니까요!

* **판타지 모험**: 판타지 모험 카드를 만드셨나요? 그렇다면 가방 안에 어떤 아이템이 있는지, 어떤 스킬을 배웠는지 등 모험 중인 캐릭터의 다양한 상태를 기록하고 싶으실 겁니다.

* **시스템/치트물**: 뭐라고요! 플레이어가 캐릭터를 연기하는 게 아니라, 캐릭터에 빙의된 **'치트 시스템'**을 연기한다고요? 그렇다면 현재 캐릭터에게 어떤 퀘스트를 줬는지, 시스템 상점에는 어떤 상품이 있는지 꼼꼼히 기록해야겠죠... 심지어 플레이어가 직접 퀘스트를 줄 수 있는 상호작용 가능한 인터페이스를 만들 수도 있습니다!

* ...... 아무튼, 자신의 카드에 어떤 변수가 필요한지 꼭, 반드시 확실하게 생각해 두세요. 이것이 이후의 모든 내용에 영향을 미치기 때문입니다!

## 🏗️ 변수 구조 설계하기
필요한 변수가 정해졌다면, 이제 변수 구조 설계를 시작해 봅시다!

여러분이 쉽게 작성할 수 있도록, 본문에서는 가능한 한 이미 만들어진 도구를 사용하여 카드를 작성하겠습니다! 예를 들어, [<u>**문지기(Gatekeeper) 작성 도우미**</u>](https://stagedog.github.io/%E9%9D%92%E7%A9%BA%E8%8E%89/%E4%BD%9C%E5%93%81%E9%9B%86/)나 [**메메(Miemie)의 Gemini CLI 자동 카드 작성 워크플로우**](https://discord.com/channels/1291925535324110879/1425536223291904151/1425536223291904151)에 있는 변수 구조 설계(스크립트) 기능을 직접 사용하여 변수 구조를 설계할 것입니다.

자, **'문지기 작성 도우미'**를 열고, 실리태번 입력창 위에 있는 <span class="highlight-box">기능 선택</span> 버튼을 통해 [변수 구조 설계(스크립트)] 기능으로 전환한 다음, 우리의 변수 요구사항을 입력해 봅시다.

```text
변수를 만들어줘!
- '월드인포(world info)' 경로 아래에 현재 시간, 현재 날짜, 최근 사건을 기록해줘.
- 주인공의 여동생 '하쿠아(白娅)'가 주인공에게 갖는 의존도, 복장, 칭호를 기록해줘.
  - 의존도는 반드시 0~100 사이여야 해.
  - 복장에는 상의, 하의, 속옷, 양말, 신발, 장신구가 포함해.
  - 칭호는 칭호의 효과와 하쿠아의 칭호에 대한 자기 평가를 기록해야 하며, 자기 평가를 입력하지 않으면 기본값을 "평가 대기 중"으로 설정할 것.
  - 칭호에는 수량 제한이 있음. 의존도가 높을수록 더 많은 칭호를 가질 수 있음(의존도가 0일 때는 칭호 없음, 1~10일 때는 1개, 이런 식으로 증가). 칭호가 소유 가능 수량을 초과하면 가장 오래된 칭호를 제거해야 함.
- 주인공의 인벤토리에 현재 있는 아이템을 기록해줘: 아이템 설명, 수량. 수량을 안 적으면 기본값은 1이야. 수량이 0 이하면 아이템을 바로 삭제해줘.
```

요구사항을 꽤 많이 입력했네요. 만약 여러분이 기존 MVU나 MVU beta에 익숙하다면, 저 요구사항들 중 상당수가 예전에는 `extensible`, `$template` 또는 별도의 스크립트를 작성해야만 구현 가능했다는 걸 아실 겁니다. 하지만 이제 MVU Zod에서는 아주 쉽게 처리할 수 있습니다!

AI도 이 방식을 잘 작성해 줍니다. 그래서 여기서는 도구를 사용해 생성하는 방법을 택했습니다. 만약 변수 구조를 직접 손으로 작성하는 법을 배우고 싶다면, 본문을 다 읽은 후 부록 부분을 참고해 주세요.

!!! warning "⚠️ 주의사항"
    변수 구조 안에서 매크로(예: `{{user}}`)를 변수 이름으로 사용하지 마세요. 대신 '주인공'처럼 매크로가 필요 없는 이름을 써야 합니다.
    
    정 쓰고 싶다면 AI에게 변수명으로 `{{user}}` 대신 `[substitudeMacros('{{user}}')]`를 쓰라고 알려줘야 하고, 오류가 안 나길 기도해야 합니다... 그러니 그냥 안 쓰는 게 편합니다.

AI가 금방 변수 구조를 생성해 줄 겁니다! 제가 얻은 결과물은 다음과 같습니다:

??? info "변수 구조"

    ```javascript
    import { registerMvuSchema } from 'https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/dist/util/mvu_zod.js';

    export const Schema = z.object({
      세계: z.object({
        현재시간: z.string(),
        현재장소: z.string(),
        최근사건: z.record(z.string().describe('사건명'), z.string().describe('사건 설명')),
      }),

      하쿠아: z
        .object({
          의존도: z.coerce.number().transform(v => _.clamp(v, 0, 100)),
          복장: z.record(z.enum(['상의', '하의', '속옷', '양말', '신발', '장신구']), z.string().describe('복장 설명')),
          칭호: z.record(
            z.string().describe('칭호명'),
            z.object({
              효과: z.string(),
              자기평가: z.string().prefault('평가 대기 중'),
            }),
          ),
        })
        .transform(data => {
          // 의존도에 따라 칭호 개수를 제한하는 로직
          data.칭호 = _(data.칭호)
            .entries()
            .takeRight(Math.ceil(data.의존도 / 10))
            .fromPairs()
            .value();
          return data;
        }),

      주인공: z.object({
        인벤토리: z
          .record(
            z.string().describe('아이템명'),
            z.object({
              설명: z.string(),
              수량: z.coerce.number().prefault(1),
            }),
          )
          // 수량이 0 이하인 아이템은 자동으로 삭제하는 로직
          .transform(data => _.pickBy(data, ({ 수량 }) => 수량 > 0)),
      }),
    });

    $(() => {
      registerMvuSchema(Schema);
    });
    ```


이 변수 구조는 실리태번 어시스턴트 스크립트로, 우리의 변수가 어떤 모습이어야 하는지를 규정합니다. '문지기 카드 작성 도우미'가 생성 직후 자신이 어떤 기능을 수행했는지 간략히 설명해 주겠지만, 굳이 지금 당장 그 내용을 해석하려고 애쓸 필요는 없습니다. 나중에 [부록: 손으로 쓰는 변수 구조] 파트에서 제가 자세히 설명해 드릴 테니까요 qwq.

이제 이것도 스크립트니까, 스크립트 라이브러리에 추가해 봅시다! MVU 본체 스크립트를 추가했을 때처럼, 실리태번 입력창 위의 블록 버튼(확장 기능) ‣ Quick Reply(혹은 스크립트 관리) ‣ 스크립트 라이브러리를 열고, +를 눌러 **변수 구조**라는 이름의 새 스크립트를 만듭니다. 내용은 방금 생성된 코드를 붙여넣으세요.

## 변수 초기화 (Initialize Variables)

변수 구조(틀)를 잡았으니, 이제 캐릭터 카드가 시작될 때의 초기 변수 값을 설정해 봅시다!

'문지기 카드 작성 도우미'를 `변수 초기 설정 (initvar)` 기능으로 전환하고, 초기화 요구사항을 입력합니다. 예를 들어 `이 스토리 지문에 맞춰서 변수를 초기화해줘`, `하쿠아의 호감도는 20 정도로 시작하고, 이에 맞춰서 오프닝 변수를 생성해줘` 등등, 여러분이 원하는 대로 적으면 됩니다.

아무튼, '문지기 카드 작성 도우미'가 제게 아래 내용을 출력해 주었는데, 여기에는 변수가 가져야 할 초기값들이 나열되어 있습니다. 자세히 살펴보면, 텍스트와 들여쓰기가 앞서 본 변수 구조 스크립트와 일대일로 일치한다는 것을 발견하실 수 있을 겁니다.


??? info "변수 초기화 예시"

    ```yaml
    세계:
      현재 시각: 2024-04-08 10:45
      현재 위치: 사립 카자마츠리 학원 고등부 2학년 A반 교실
      최근 이슈:
        전학생 배치: 하쿠아가 막 전학을 옴. 교재를 수령 및 학교 안내 필요
        자리 배치: 반장이 최종 좌석표를 확인 중이라 약간의 변동이 있을 수 있음
        점심시간 임박: 1교시만 지나면 점심시간, 백야에게 접근할 기회임
    백야:
      의존도: 35
      복장:
        상의: 단정한 짙은 남색 교복 재킷, 단추를 하나도 빠짐없이 꼼꼼하게 잠갔음
        하의: 반듯한 짙은 남색 플리츠 스커트, 무릎에 딱 떨어지는 길이
        속옷: 순백색 속옷 세트
        양말: 검은색 오버니삭스, 주름 하나 없이 팽팽함
        신발: 검은색 가죽 학생화, 반짝이게 닦여 있음
        장신구: 없음
      칭호:
        송장:
          효과: 평소 행동에서 눈에 띄는 권태감과 기계적인 느낌이 묻어남
          자평: 살아있는 것 자체가 형벌이다
        도피자:
          효과: <user>의 모든 접촉을 본능적으로 회피함
          자평: 난 그 사람 인생에 끼어들 자격이 없어
    주인공:
      소지품:
        낡은 반창고:
          설명: 지갑 틈새에 2년이나 넣어둔 캐릭터 반창고, 접착력은 아마 다 날아갔을 것임
          수량: 1
        박하사탕:
          설명: 잠 깨는 용도의 강력 박하사탕, 예전에 그녀는 이 냄새를 아주 싫어했음
          수량: 1
    ```


이 초기값을 얻었다면, MVU가 이해할 수 있는 방식으로 알려줘야 합니다.

캐릭터 카드의 **월드 인포(World Info)**에 새로운 항목을 하나 만들어 봅시다. 항목 이름에는 반드시 `[initvar]`가 포함되어야 하며, **반드시 '비활성화(Disabled)'** 상태여야 합니다. 항목 이름은 `[initvar]변수초기화_켜지마` 정도로 해두는 게 좋겠네요! 그런 다음, 방금 얻은 변수 초기값을 월드 인포에 붙여넣으세요.

# 변수 구조 및 초기화 검증하기

변수 구조와 초기값을 설정했다면, 다음 두 가지를 확실히 확인해야 합니다.

* <span class="highlight-box">API 설정(좌측 상단 플러그 아이콘)</span>에서 **'Chat Completion'** 모드인지 확인.

* 캐릭터 카드에 **오프닝 메시지(그리팅)**가 설정되어 있는지 확인.

이 두 가지가 준비되었다면, 이제 새 채팅을 시작하여 변수 설정을 적용 할 수 있습니다!

채팅을 새로 시작한 후, 변수가 제대로 들어갔는지 확인해 봅시다. <span class="highlight-box">입력창 왼쪽 마술봉 아이콘 ‣ 변수 관리자(Variable Manager) ‣ 메시지 층(Message Scope)</span> 만약 새 채팅을 시작했는데도 변수 관리자에 아무런 변수가 없다면, 이전 단계들을 올바르게 수행했는지 먼저 점검해 주세요!

<img src="https://vwdygpvfycixugqsgwgn.supabase.co/storage/v1/object/public/post-images/1980dc04-3f08-4581-88cb-b949a10d585b/83bbaf6d-6b47-4654-821f-dcd0d716cc1b.png" alt="마법봉을 클릭해 연 모습" class="center-img">

!!! warning "⚠️ 트러블슈팅: '변수 초기화 실패' 경고가 뜰 때"
    혹시 새 채팅을 시작했을 때, 노란색 상자로 **"변수 초기화 실패(Variable Initialization Failed)"**라는 경고가 떴나요? 경고창의 제목을 확인해 보세요.

**1. 경고 제목이 [MVU]인 경우**

원인: 변수 구조 스크립트에 오류가 있습니다. 

해결: 변수 구조 스크립트를 껐다가 다시 켜보세요. 오류 로그를 확인합니다.

PC는 <span class="highlight-box">F12를 눌러 개발자 도구의 콘솔(Console)</span> 탭 확인하시고 모바일은 <span class="highlight-box">입력창 좌측 하단 마술봉 ‣ 로그 뷰어(Log Viewer)</span>을 확인하세요.

빨간색 오류 메시지가 있다면 복사해서 AI에게 보내고, 스크립트 수정을 요청하세요. 빨간색 오류가 없다면, 그냥 AI에게 스크립트를 다시 작성해달라고 하세요. 

정 해결이 안 된다면 게시글을 통해 원작자(Qingkong Li)에게 물어보세요.

**2. 경고 제목이 [MVU zod]인 경우**

원인: 변수 초기값(initvar) 내용에 오류가 있습니다.

해결: 위와 마찬가지로 <span class="highlight-box">PC는 F12 키를 누른 뒤 콘솔(개발자 도구)</span>를 이용. 모바일 기기에서는 <span class="highlight-box">마법봉 아이콘(로그 뷰어)</span>에서 방금 발생한 오류 로그를 복사한 뒤, 이를 AI에게 보내고 변수 초기값을 다시 생성해달라고 요청하세요.

# 오프닝별로 다른 변수 초기값 설정하기 (전체 적용 방안)

캐릭터 카드의 각 오프닝(Greeting)은 보통 서로 다른 스토리 상황을 다루고 있습니다. 따라서 오프닝마다 서로 다른 변수 초기값을 설정해야 할 필요가 분명히 존재합니다.

MVU를 사용하면 이제 각기 다른 변수 초기값을 설정하는 것이 매우 간단합니다. 그저 오프닝 메시지 안에 `<initvar>...</initvar>` 태그를 사용하여 해당 오프닝에 적용할 변수 초기값을 감싸주기만 하면 됩니다.

=== "그리팅 메시지"

    ```xml
    오프닝 2의 스토리 본문...
    <UpdateVariable> <!-- 추후 실리태번의 정규식(Regex) 처리를 용이하게 하기 위해, 바깥쪽을 <UpdateVariable>로 한 번 더 감싸줍니다. -->
    <initvar>
    오프닝 2에 적용할 변수 초기값...
    </initvar>
    </UpdateVariable>
    ```

=== "변수 초기값 직접 입력"

    오프닝 2의 스토리...

    ```xml
    <UpdateVariable>
    <initvar>
    세계:
      현재 시간: 2025년 4월 7일 월요일 08:42
      현재 장소: 사립 카자마츠리 2학년 A반 교실
      최근 사건:
        백아 전학: 백아가 막 사립 성견 학원 2학년 A반으로 전학 와서 짧은 자기소개를 마침
        청공려 재학 중: 청공려는 같은 학교 육상부 코치 조수로 일하고 있으며, 백아가 우연히 이 사실을 알게 됨
        쉬는 시간: 수학 수업이 끝나고, 학생들이 자유롭게 활동하며 대화하기 시작함
    백아:
      의존도: 15
      복장:
        상의: 단정한 사립 성견 학원 여학생 교복
        하의: 단정한 사립 성견 학원 여학생 교복
        속옷: 흰색 면 속옷 세트
        양말: 흰색 오버니삭스
        신발: 검은색 가죽 학생화
        장신구: 없음
      칭호:
        전학생:
          효과: 갓 전학 와서 환경이 낯섦. 타인의 주의를 끌기 쉬우나 본인은 조용히 지내고 싶어 함
          자평: 또 새로운 시작이지만, 난 분명 또 모든 걸 망칠 거야
        도피자:
          효과: 습관적인 회피가 고통스러운 인간관계를 가져올 수 있지만, 내심 온기를 갈망함
          자평: 나 같은 사람은 관계를 맺을 자격이 없어. 멀어지는 게 모두를 위한 최선의 선택이야
        자기 파괴 성향:
          효과: 자기 부정과 자해를 통해 스스로를 벌하며, 고통을 마땅한 것으로 여김
          자평: 살아있는 것 자체가 내 가장 큰 형벌이며, 이 고통은 내가 마땅히 받아야 할 몫이야
    주인공:
      소지품:
        낡은 손수건:
          설명: 구석에 삐뚤빼뚤한 토끼가 수놓아진 손수건. 오래되었지만 아주 깨끗하게 세탁되어 있음
          수량: 1
        초시계:
          설명: 육상부에서 사용하는 타이머, 목에 걸고 있음
          수량: 1
    </initvar>
    </UpdateVariable>
    ```

=== "코드 블록으로 감싸기"

    오프닝 2의 스토리 본문...

    ````text hl_lines="3"
    <UpdateVariable>
    <initvar>
    ```yaml
    세계:
      현재 시간: 2025년 4월 7일 월요일 08:42
      현재 장소: 사립 카자마츠리 학원 2학년 A반 교실
      최근 사건:
        백아 전학: 백아가 막 사립 성견 학원 2학년 A반으로 전학 와서 짧은 자기소개를 마침
        청공려 재학 중: 청공려는 같은 학교 육상부 코치 조수로 일하고 있으며, 백아가 우연히 이 사실을 알게 됨
        쉬는 시간: 수학 수업이 끝나고, 학생들이 자유롭게 활동하며 대화하기 시작함
    백아:
      의존도: 15
      복장:
        상의: 단정한 사립 성견 학원 여학생 교복
        하의: 단정한 사립 성견 학원 여학생 교복
        속옷: 흰색 면 속옷 세트
        양말: 흰색 오버니삭스
        신발: 검은색 가죽 학생화
        장신구: 없음
      칭호:
        전학생:
          효과: 갓 전학 와서 환경이 낯섦. 타인의 주의를 끌기 쉬우나 본인은 조용히 지내고 싶어 함
          자평: 또 새로운 시작이지만, 난 분명 또 모든 걸 망칠 거야
        도피자:
          효과: 습관적인 회피가 고통스러운 인간관계를 가져올 수 있지만, 내심 온기를 갈망함
          자평: 나 같은 사람은 관계를 맺을 자격이 없어. 멀어지는 게 모두를 위한 최선의 선택이야
        자기 파괴 성향:
          효과: 자기 부정과 자해를 통해 스스로를 벌하며, 고통을 마땅한 것으로 여김
          자평: 살아있는 것 자체가 내 가장 큰 형벌이며, 이 고통은 내가 마땅히 받아야 할 몫이야
    주인공:
      소지품:
        낡은 손수건:
          설명: 구석에 삐뚤빼뚤한 토끼가 수놓아진 손수건. 오래되었지만 아주 깨끗하게 세탁되어 있음
          수량: 1
        초시계:
          설명: 육상부에서 사용하는 타이머, 목에 걸고 있음
          수량: 1
    ```
    </initvar>
    </UpdateVariable>
    ````   

즉, `[initvar] 변수 초기화(열지 않음)` 항목은 모든 오프닝에 대한 **"최소한의 안전장치(보트)"**로서의 변수 초기화이며, 오프닝 내부의 `<initvar>...</initvar>`는 **특정 오프닝만을 위해 개별적으로 설정**하는 변수 초기화입니다.

* 만약 오프닝 안에 `<initvar>...</initvar>`가 설정되어 있다면, 해당 오프닝은 `[initvar] 변수 초기화(열지 않음)` 항목을 **완전히 무시**하고, `<initvar>...</initvar>` 블록을 사용하여 변수를 초기화합니다.
* 반대로, 오프닝 안에 `<initvar>...</initvar>`가 설정되어 있지 않다면, 해당 오프닝은 `[initvar] 변수 초기화(열지 않음)` 항목을 사용하여 변수를 초기화합니다.

!!! tip "팁"
    `<initvar>...</initvar>`와 같은 초기화 방법이 존재하기 때문에, 월드 인포(World Info)에 `[initvar] 변수 초기화(열지 않음)` 항목을 아예 만들지 않고, **모든 오프닝마다 개별적으로 `<initvar>...</initvar>` 블록을 설정**하는 것도 완전히 가능한 방법입니다.

당연하게도, `<initvar>...</initvar>`의 작성법은 `[initvar] 변수 초기화(열지 않음)` 항목과 완전히 동일합니다. 따라서:

* 만약 오프닝마다 변수 초기값이 **많이 다르다면**, <span class="highlight-box">[문지기 카드 작성 도우미 - 변수 초기 설정(initvar)] 기능</span>을 사용하여 생성할 수 있습니다.
* 만약 차이가 크지 않다면, `실리태번 입력창 왼쪽 마술봉 아이콘` ‣ `변수 관리자(Variable Manager)` ‣ `메시지(Message)` 탭에서 변수 초기값을 직접 수정한 뒤, 수정된 결과를 `<initvar>` 블록 안에 복사해 넣으면 됩니다.

<video width="400" controls class="center-img">
  <source src="../../assets/videos/copy-variable.mp4" type="video/mp4">
</video>

